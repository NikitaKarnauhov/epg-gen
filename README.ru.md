epg-gen
=======

`epg-gen` это инструмент для создания [электронной программы телепередач
](https://ru.wikipedia.org/wiki/Electronic_Program_Guide) в формате
[XMLTV](http://xmltv.org) по заданному M3U8-плейлисту. Он предназначен для
подписчиков российских провайдеров IPTV, желающих использовать данные EPG с
совместимыми медиапроигрывателями (например, [Kodi](https://kodi.tv) с
[подходящим дополнением](http://kodi.wiki/view/Add-on:IPTV_Simple_Client)).  На
текущий момент реализованы скрейперы для <https://tv.yandex.ru> и
<https://tv.mail.ru> (по этой причине поддерживаются, в основном, русскоязычные
каналы).

Использование
-------------

Допустим вы скачали плейлист `sample.m3u8` с сайта вашего IPTV провайдера. Он
может выглядеть как-то так (только с большим количеством каналов):

```
#EXTM3U
#EXTINF:0,РБК
#EXTGRP:новости
http://192.0.2.1/1
#EXTINF:0,Россия
#EXTGRP:новости
http://192.0.2.1/2
#EXTINF:0,Первый канал
#EXTGRP:другие
http://192.0.2.1/3
```

Сначала нужно сопоставить каналы из плейлиста каналам, доступным через
скрейперы, с помощью команды `epg-gen match`:

```
> epg-gen match sample.m3u8
2 channel(s) matched
1 channel(s) not matched:
    Россия
```

Обратите внимание, что найти сопоставление для одного из каналов здесь не
удалось. Чтобы это исправить, перезапустим команду с опциями `--interactive`
(`-i`) и `--offline` (`-n`). В интерактивном режиме, если каналу не удаётся
найти соответствие с достаточной уверенностью, запрашивается пользовательский
ввод. В оффлайновом же режиме запрещается повторное скачивание списков каналов
из источников:

```
> epg-gen match -i -n sample.m3u8

Choose channel mapping for "Россия":
A. (skip all)
0. (skip)
1. "Россия 1" (mailru)
2. "Россия 1 HD" (mailru)
3. "Россия 1" (yandex)
4. "М тв россия" (yandex)
5. "Россия 1 HD" (yandex)
6. "Россия 24" (yandex)
7. "MTV Россия" (mailru)
8. "М тиви россия" (yandex)
9. "Мтиви россия" (yandex)
10. "Мтв россия" (yandex)
Enter (0 .. 10 or "A", default: 0): 3

3 channel(s) matched
```

Можно ознакомиться со списком сопоставленных каналов с помощью команды `epg-gen
list -m`:

```
> epg-gen list -m
ID | name         | scraper | scraper ID | scraper name
 1 | РБК          |  mailru |       1126 | РБК
 3 | Первый канал |  yandex |        146 | Первый
 2 | Россия       |  yandex |        711 | Россия 1
```

После этого можно сгенерировать EPG командой `epg-gen build`:

```
> epg-gen build xmltv.xml.gz
```

Результат будет сжат, если указанное имя файла имеет расширение `.gz`. Обратите
внимание, что генерация XMLTV может занять довольно много времени (в
зависимости от предпочитаемого скрейпера и количества каналов), т.к. оно
подразумевает скачивание описаний программ на всю неделю. Скачанные данные
кэшируются чтобы ускорить пересохранение XMLTV, например, при добавлении
каналов.

